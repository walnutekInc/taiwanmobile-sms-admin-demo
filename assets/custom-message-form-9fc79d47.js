import{_ as fe}from"./index.vuevuetypescriptsetuptruelang-4c3d11b4.js";import{d as q,ag as ee,ah as _e,o as ge,j as ve,r as U,f as M,w as W,y as xe,W as D,X as J,_ as P,u as e,a8 as ye,Y as m,Q as we,F as oe,k as t,$ as n,a3 as Ce,a4 as le,H as Q,G as w,ad as be,ac as he,c as te,D as ke,ab as L,B as Se,m as ne,A as se,a5 as $e}from"./vue-b9a22f97.js";import{_ as ie}from"./index.vuevuetypescriptsetuptruelang-4fca776e.js";import{h as Me,j as Te,_ as Re}from"./index-dfeff907.js";import{E as re,G as Fe,H as O,J as Ie,B as Be,s as De,q as He,r as Ve,I as Ae,K as Ee,u as Ne,F as je}from"./antd-b020a38c.js";import{u as Ke}from"./sms-category-9ef8cb4d.js";import{F as Le,_ as Oe}from"./request-6ddf16f6.js";import{u as ce,r as ae,a as Ue}from"./custom-message-0445dd34.js";import"./context-4d07b20e.js";const Pe={class:"form-textarea-tools py-2"},qe=q({__name:"index",props:ee({tag:String,contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:ee({returned:String},["update:modelValue"]),setup(T,{emit:R}){function b(a,i,C){return a.split(i).join(C)}const g=T,r=_e(T,"modelValue");ge(()=>{document.addEventListener("selectionchange",h)}),ve(()=>{document.removeEventListener("selectionchange",h)});function d(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const v=U({contentId:`content${d()}`,isLocked:!1,currentTagId:null,savedRange:{}}),F=R;function h(){var i;let a=window.getSelection();if(a){let C=a.rangeCount>0?a.getRangeAt(0):null;C&&((i=C.commonAncestorContainer.ownerDocument)!=null&&i.activeElement)&&C.commonAncestorContainer.ownerDocument.activeElement.id===v.contentId&&(v.savedRange=C)}}const u=M();function o(){return g.noHtml?u.value.innerText:u.value.innerHTML}function c(a){g.noHtml?u.value.innerText=e(a):u.value.innerHTML=e(a)}function k(){r.value=o()}function p(a){a.preventDefault();let i=(a.originalEvent||a).clipboardData.getData("text/plain");g.noNl&&(i=b(i,`\r
`," "),i=b(i,`
`," "),i=b(i,"\r"," ")),window.document.execCommand("insertText",!1,i)}function l(a){a.key=="Enter"&&g.noNl&&(a.preventDefault(),F("returned",o()))}return W(r,async a=>{await xe(),a!=o()&&c(a??"")}),W(()=>g.noHtml,()=>{c(r??"")}),W(()=>g.tag,()=>{c(r??"")},{flush:"post"}),(a,i)=>(D(),J(oe,null,[(D(),P(ye("div"),{class:"tag-textarea",id:e(v).contentId,contenteditable:T.contenteditable,onInput:k,onBlur:k,onPaste:p,onKeypress:l,ref_key:"element",ref:u,"data-placeholder":T.placeholder},null,40,["id","contenteditable","data-placeholder"])),m("div",Pe,[we(a.$slots,"default")])],64))}});const Ge="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",ze={class:"px-24px"},We={key:0,class:"line-clamp-2"},Je=m("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),Qe=q({__name:"import-custom-message",emits:["updateContent"],setup(T,{expose:R,emit:b}){const g=b,r=U({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:d,getCustomMessages:v,pagination:F}=ce(),h=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],u=M({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),o=async(_,x,S)=>{console.log("pagination:",_,"sorter:",S),u.value=Object.assign(u.value,{sortField:S.field,sortOrder:S.order}),await c(_.current,_.pageSize)},c=async(_=1,x=10)=>{let S={current:_,pageSize:x,...e(u)};await v(S)},k=(_,x)=>{console.log("selectedRowKeys changed: ",_,x),r.selectedRowKeys=_,r.selectedRows=x},p=M(!1),l=async()=>{r.selectedRowKeys=[],r.selectedRows=[],c(),p.value=!0},a=M(!1),i=()=>{a.value=!0},C=()=>{var _;p.value=!1,a.value=!1,g("updateContent",(_=r.selectedRows[0])==null?void 0:_.content)};return R({show:l}),(_,x)=>{const S=Le,E=Oe,N=re;return D(),J(oe,null,[t(N,{open:e(p),"onUpdate:open":x[0]||(x[0]=I=>Q(p)?p.value=I:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:i,width:"960px"},{default:n(()=>[m("div",ze,[t(S,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(E,{class:"modal-table",dataSource:e(d),columns:h,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(r).selectedRowKeys,onChange:k,type:"radio"},onChange:o,pagination:{...e(F)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:I,text:j})=>[I.dataIndex==="content"?(D(),J("div",We,Ce(j),1)):le("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open"]),t(N,{open:e(a),"onUpdate:open":x[1]||(x[1]=I=>Q(a)?a.value=I:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:C,width:"440px"},{default:n(()=>[Je]),_:1},8,["open"])],64)}}}),Xe={class:"px-24px"},Ye=m("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),Ze={class:"flex justify-between gap-x-2"},et=m("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[w(" 加入參數功能說明："),m("br"),w(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),tt=q({__name:"add-field",emits:["addFieldToContent"],setup(T,{expose:R,emit:b}){const g=b,r=M(!1),d=M([]),v=u=>{d.value.includes(u)?d.value=d.value.filter(o=>o!==u):d.value.push(u)},F=async()=>{d.value=[],r.value=!0},h=()=>{r.value=!1,g("addFieldToContent",d.value)};return R({show:F}),(u,o)=>{const c=ie,k=re;return D(),P(k,{open:e(r),"onUpdate:open":o[5]||(o[5]=p=>Q(r)?r.value=p:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:h,width:"600px"},{default:n(()=>[m("div",Xe,[Ye,m("div",Ze,[t(c,{status:e(d).includes("%field1%")?"small1":"small2",onClick:o[0]||(o[0]=p=>v("%field1%"))},{default:n(()=>[w("%field1%")]),_:1},8,["status"]),t(c,{status:e(d).includes("%field2%")?"small1":"small2",onClick:o[1]||(o[1]=p=>v("%field2%"))},{default:n(()=>[w("%field2%")]),_:1},8,["status"]),t(c,{status:e(d).includes("%field3%")?"small1":"small2",onClick:o[2]||(o[2]=p=>v("%field3%"))},{default:n(()=>[w("%field3%")]),_:1},8,["status"]),t(c,{status:e(d).includes("%field4%")?"small1":"small2",onClick:o[3]||(o[3]=p=>v("%field4%"))},{default:n(()=>[w("%field4%")]),_:1},8,["status"]),t(c,{status:e(d).includes("%field5%")?"small1":"small2",onClick:o[4]||(o[4]=p=>v("%field5%"))},{default:n(()=>[w("%field5%")]),_:1},8,["status"])]),et])]),_:1},8,["open"])}}}),nt={class:"bg-sms-grayscale-0 rounded-4 flex justify-center p-10"},st={class:"flex-1 me-8"},at={class:"flex justify-between w-full items-center"},ot=m("span",{class:""},"訊息類別",-1),lt=m("span",null,"新增訊息類別",-1),it={class:"relative"},rt=["src"],ct=["innerHTML"],yt=q({__name:"custom-message-form",setup(T){const R=be(),b=Me(),g=he(),r=Te(),{getSmsCategoryOption:d,smsCategoryOption:v,checkSmsCategoryExist:F}=Ke(),{customMeesage:h,getCustomMessage:u}=ce(),o=te(()=>g.name=="CustomMessageCreate");ke(async()=>{var y,s,f,B,K;if(!o.value){await u(g.params.id);const H=(K=(B=(f=(s=(y=h.value)==null?void 0:y.content)==null?void 0:s.replace("%field1%","<span>%field1%</span>"))==null?void 0:f.replace("%field2%","<span>%field2%</span>").replace("%field3%","<span>%field3%</span>"))==null?void 0:B.replace("%field4%","<span>%field4%</span>"))==null?void 0:K.replace("%field5%","<span>%field5%</span>");x({...h.value,content:H})}b.handleSelectedKeys(["/sms-marketing/custom-message"]),d()});const c=M(!0),k=te(()=>o.value?"新增自訂訊息":"編輯自訂訊息"),l=U(Fe({categoryId:void 0,newSmsCategory:"",name:"",content:""})),a=U({content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(y,s){var f;return!O(s)&&((f=l.content)==null?void 0:f.replace(ae,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(y,s){return!O(s)&&await F(s)?Promise.reject(`系統中已有「${s}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:i,validate:C,clearValidate:_,resetFields:x}=Ie(l,a),S=()=>{C().then(()=>{r.success({message:e(o)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),R.push("/sms-marketing/custom-message?tabActived=customMessage")}).catch(y=>{console.log(y)})},E=M(null),N=y=>{var s,f,B;l.content=(B=(f=(s=y.replace("%field1%","<span>%field1%</span>"))==null?void 0:s.replace("%field2%","<span>%field2%</span>").replace("%field3%","<span>%field3%</span>"))==null?void 0:f.replace("%field4%","<span>%field4%</span>"))==null?void 0:B.replace("%field5%","<span>%field5%</span>")},I=y=>{for(const s of y)l.content=`${l.content}<span>${s}</span>`},j=M(null);return(y,s)=>{const f=Re,B=Be,K=De,H=He,V=Ve,G=ie,X=Ae,Y=Ee,de=qe,ue=Ne,me=je,pe=fe;return D(),P(pe,{title:e(k),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",title:"自訂訊息"},{title:e(k)}]},{default:n(()=>{var Z;return[m("div",nt,[m("div",st,[t(me,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:S},{default:n(()=>[t(ue,{gutter:[16,16]},{default:n(()=>[t(V,{span:24},{default:n(()=>[t(H,L(e(i).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[m("div",at,[ot,e(c)?(D(),P(B,{key:0,type:"link",class:"m-0 p-0",onClick:s[0]||(s[0]=Se(()=>c.value=!1,["prevent"]))},{icon:n(()=>[t(f,{name:"plus"})]),default:n(()=>[w(" 新增訊息類別 ")]),_:1})):le("",!0)])]),default:n(()=>[t(K,{value:e(l).categoryId,"onUpdate:value":s[1]||(s[1]=$=>e(l).categoryId=$),options:e(v),"allow-clear":"",disabled:!e(c),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),ne(t(V,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(H,L({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(i).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[lt,t(G,{status:"small3",class:"m-0 p-0 ms-auto",onClick:s[2]||(s[2]=()=>{e(l).newSmsCategory="",e(_)("newSmsCategory"),c.value=!0})},{icon:n(()=>[t(f,{name:"close"})]),_:1})]),default:n(()=>[t(X,{placeholder:"請輸入訊息類別",maxlength:15,value:e(l).newSmsCategory,"onUpdate:value":s[3]||(s[3]=$=>e(l).newSmsCategory=$)},null,8,["value"])]),_:1},16)]),_:1},512),[[se,!e(c)]]),t(V,{span:24},{default:n(()=>[t(H,L({label:"訊息名稱"},e(i).name,{extra:"15 字以內"}),{default:n(()=>[t(X,{value:e(l).name,"onUpdate:value":s[4]||(s[4]=$=>e(l).name=$),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(V,{span:24},{default:n(()=>{var $;return[t(H,L({label:"訊息內容"},e(i).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(O)(e(l).content)?"--":($=e(l).content)==null?void 0:$.replace(e(ae),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>[t(de,{tag:"a-textarea",contenteditable:"true",modelValue:e(l).content,"onUpdate:modelValue":s[7]||(s[7]=z=>e(l).content=z),placeholder:"請輸入訊息名稱"},{default:n(()=>[t(Y,null,{title:n(()=>[w(" 載入現有的自訂訊息 ")]),default:n(()=>[t(f,{name:"import",onClick:s[5]||(s[5]=z=>{var A;return(A=e(E))==null?void 0:A.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(Y,null,{title:n(()=>[w(" 加入參數 ")]),default:n(()=>[t(f,{onClick:s[6]||(s[6]=z=>{var A;return(A=e(j))==null?void 0:A.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(f,{name:"link",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(f,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue"])]),_:1},16,["extra"])]}),_:1}),t(V,{span:24,class:"text-end"},{default:n(()=>[t(G,{status:"small2",class:"me-2",onClick:s[8]||(s[8]=$=>y.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[w("取消")]),_:1}),t(G,{status:"small1","html-type":"submit"},{default:n(()=>[w("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),m("div",it,[m("img",{src:e(Ge),class:$e("w-428px")},null,8,rt),ne(m("div",{class:"absolute top-[150px] left-[30px] bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:(Z=e(l).content)==null?void 0:Z.replace(e(Ue),"")},null,8,ct),[[se,!e(O)(e(l).content)]])])]),t(Qe,{ref_key:"importCustomMessageRef",ref:E,onUpdateContent:N},null,512),t(tt,{ref_key:"addFieldRef",ref:j,onAddFieldToContent:I},null,512)]}),_:1},8,["title","customBreadcrumb"])}}});export{yt as default};
