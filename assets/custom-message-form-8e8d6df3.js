import{_ as Ce}from"./index.vuevuetypescriptsetuptruelang-edb898c7.js";import{d as U,ag as te,ah as be,o as le,j as ke,r as K,f as T,w as z,y as he,W as H,X as W,_ as O,u as e,a8 as Se,Y as v,Q as Me,F as re,k as t,$ as n,a3 as $e,a4 as ce,H as J,G as h,ad as ie,l as Te,ac as Re,c as ne,D as Fe,ab as N,B as Ie,m as se,A as oe,a5 as Be}from"./vue-b9a22f97.js";import{_ as ue}from"./index.vuevuetypescriptsetuptruelang-6de7385f.js";import{j as He,h as Ae,k as De,_ as Ve}from"./index-b73c7166.js";import{E as V,G as de,H as Ee,J as Le,K as Ne,B as Ke,s as Oe,q as Ue,r as je,I as qe,N as Pe,u as Ge,F as ze}from"./antd-100bd80b.js";import{u as We}from"./sms-category-251b2189.js";import{F as Je,_ as Qe}from"./request-2a151a2a.js";import{u as me,r as ae,a as Xe}from"./custom-message-e93fa110.js";import"./context-f31a7bac.js";const Ye={class:"form-textarea-tools py-2"},Ze=U({__name:"index",props:te({contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:te({returned:String},["update:modelValue"]),setup(M,{emit:g}){function S(l,c,_){return l.split(c).join(_)}const p=M,u=be(M,"modelValue");le(()=>{document.addEventListener("selectionchange",x)}),ke(()=>{document.removeEventListener("selectionchange",x)});function a(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const i=K({contentId:`content${a()}`,isLocked:!1,currentTagId:null,savedRange:{}}),F=g;function x(){var c;let l=window.getSelection();if(l){let _=l.rangeCount>0?l.getRangeAt(0):null;_&&((c=_.commonAncestorContainer.ownerDocument)!=null&&c.activeElement)&&_.commonAncestorContainer.ownerDocument.activeElement.id===i.contentId&&(i.savedRange=_)}}const f=T();function r(){return p.noHtml?f.value.innerText:f.value.innerHTML}function y(l){p.noHtml?f.value.innerText=e(l):f.value.innerHTML=e(l)}function R(){u.value=r()}function w(l){l.preventDefault();let c=(l.originalEvent||l).clipboardData.getData("text/plain");p.noNl&&(c=S(c,`\r
`," "),c=S(c,`
`," "),c=S(c,"\r"," ")),window.document.execCommand("insertText",!1,c)}function $(l){l.key=="Enter"&&p.noNl&&(l.preventDefault(),F("returned",r()))}return z(u,async l=>{await he(),l!=r()&&y(l??"")}),z(()=>p.noHtml,()=>{y(u??"")}),(l,c)=>(H(),W(re,null,[(H(),O(Se("div"),{class:"tag-textarea",id:e(i).contentId,contenteditable:M.contenteditable,onInput:R,onBlur:R,onPaste:w,onKeypress:$,ref_key:"element",ref:f,"data-placeholder":M.placeholder},null,40,["id","contenteditable","data-placeholder"])),v("div",Ye,[Me(l.$slots,"default")])],64))}});const et="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",tt={class:"px-24px"},nt={key:0,class:"line-clamp-2"},st=v("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),ot=U({__name:"import-custom-message",props:{content:{type:String,required:!0}},emits:["updateContent"],setup(M,{expose:g,emit:S}){const p=M,u=S,a=K({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:i,getCustomMessages:F,pagination:x}=me(),f=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],r=T({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),y=async(s,C,b)=>{console.log("pagination:",s,"sorter:",b),r.value=Object.assign(r.value,{sortField:b.field,sortOrder:b.order}),await R(s.current,s.pageSize)},R=async(s=1,C=10)=>{let b={current:s,pageSize:C,...e(r)};await F(b)},w=(s,C)=>{console.log("selectedRowKeys changed: ",s,C),a.selectedRowKeys=s,a.selectedRows=C},$=T(!1),l=async()=>{a.selectedRowKeys=[],a.selectedRows=[],R(),$.value=!0},c=T(!1),_=()=>{V(p.content)?A():c.value=!0},A=()=>{var s;$.value=!1,c.value=!1,u("updateContent",(s=a.selectedRows[0])==null?void 0:s.content)};return g({show:l}),(s,C)=>{const b=Je,j=Qe,E=de;return H(),W(re,null,[t(E,{open:e($),"onUpdate:open":C[0]||(C[0]=I=>J($)?$.value=I:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:_,width:"960px",okButtonProps:{disabled:e(a).selectedRowKeys.length===0}},{default:n(()=>[v("div",tt,[t(b,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(j,{class:"modal-table",dataSource:e(i),columns:f,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(a).selectedRowKeys,onChange:w,type:"radio"},onChange:y,pagination:{...e(x)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:I,text:q})=>[I.dataIndex==="content"?(H(),W("div",nt,$e(q),1)):ce("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open","okButtonProps"]),t(E,{open:e(c),"onUpdate:open":C[1]||(C[1]=I=>J(c)?c.value=I:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:A,width:"440px"},{default:n(()=>[st]),_:1},8,["open"])],64)}}}),at={class:"px-24px"},lt=v("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),rt={class:"flex justify-between gap-x-2"},ct=v("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[h(" 加入參數功能說明："),v("br"),h(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),it=U({__name:"add-field",emits:["addFieldToContent"],setup(M,{expose:g,emit:S}){const p=S,u=T(!1),a=T([]),i=f=>{a.value.includes(f)?a.value=a.value.filter(r=>r!==f):a.value.push(f)},F=async()=>{a.value=[],u.value=!0},x=()=>{u.value=!1,p("addFieldToContent",a.value)};return g({show:F}),(f,r)=>{const y=ue,R=de;return H(),O(R,{open:e(u),"onUpdate:open":r[5]||(r[5]=w=>J(u)?u.value=w:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:x,width:"600px"},{default:n(()=>[v("div",at,[lt,v("div",rt,[t(y,{status:e(a).includes("%field1%")?"small1":"small2",onClick:r[0]||(r[0]=w=>i("%field1%"))},{default:n(()=>[h("%field1%")]),_:1},8,["status"]),t(y,{status:e(a).includes("%field2%")?"small1":"small2",onClick:r[1]||(r[1]=w=>i("%field2%"))},{default:n(()=>[h("%field2%")]),_:1},8,["status"]),t(y,{status:e(a).includes("%field3%")?"small1":"small2",onClick:r[2]||(r[2]=w=>i("%field3%"))},{default:n(()=>[h("%field3%")]),_:1},8,["status"]),t(y,{status:e(a).includes("%field4%")?"small1":"small2",onClick:r[3]||(r[3]=w=>i("%field4%"))},{default:n(()=>[h("%field4%")]),_:1},8,["status"]),t(y,{status:e(a).includes("%field5%")?"small1":"small2",onClick:r[4]||(r[4]=w=>i("%field5%"))},{default:n(()=>[h("%field5%")]),_:1},8,["status"])]),ct])]),_:1},8,["open"])}}}),ut=()=>{const M=ie(),g=T(!1),S=()=>g.value=!0,p=()=>g.value=!1,u=He();M.beforeResolve((i,F,x)=>{e(g)?u.confirm({closable:!0,width:"440px",icon:()=>"",title:"是否放棄目前編輯的內容？",content:Te("div",{class:"text-center !w-full !max-w-full py-20px text-base mx-auto",innerHTML:"您將離開現在的頁面，且編輯的內容不會存檔"}),okText:"確定",cancelText:"取消",centered:!0,onOk:()=>{p(),x()},onCancel:()=>{x(!1)}}):x()});const a=i=>{e(g)&&(i.preventDefault(),i.returnValue=!0)};return le(()=>{window.addEventListener("beforeunload",a)}),{setShowAlert:S,setHideAlert:p}},dt={class:"flex justify-between w-full items-center"},mt=v("span",{class:""},"訊息類別",-1),pt=v("span",null,"新增訊息類別",-1),ft=["src"],_t=["innerHTML"],St=U({__name:"custom-message-form",setup(M){const{setHideAlert:g,setShowAlert:S}=ut(),p=ie(),u=Ae(),a=Re(),i=De(),{getSmsCategoryOption:F,smsCategoryOption:x,checkSmsCategoryExist:f}=We(),{customMeesage:r,getCustomMessage:y,updateCustomMessage:R,createCustomMessage:w,replaceFieldToHtml:$}=me(),l=ne(()=>a.name=="CustomMessageCreate");let c={categoryId:void 0,newSmsCategory:"",name:"",content:""};Fe(async()=>{var d,o,m;l.value||(await y(a.params.id),c={categoryId:(d=r.value)==null?void 0:d.categoryId,newSmsCategory:"",name:((o=r.value)==null?void 0:o.name)??"",content:$((m=r.value)==null?void 0:m.content)},I(c)),u.handleSelectedKeys(["/sms-marketing/custom-message"]),F()});const _=T(!0),A=ne(()=>l.value?"新增自訂訊息":"編輯自訂訊息"),s=K(Ee(c));z(()=>s,d=>{Le(d,c)?g():S()},{deep:!0});const C=K({content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(d,o){var m;return!V(o)&&((m=s.content)==null?void 0:m.replace(ae,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(d,o){return!V(o)&&await f(o)?Promise.reject(`系統中已有「${o}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:b,validate:j,clearValidate:E,resetFields:I,initialModel:q}=Ne(s,C),pe=()=>{console.log(q),j().then(async()=>{var m;((m=(await(e(l)?w:R)(s,a.params.id)).data)==null?void 0:m.status)==="success"&&(i.success({message:e(l)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),g(),p.push("/sms-marketing/custom-message?tabActived=customMessage"))}).catch(d=>{console.log(d)})},Q=T(null),fe=d=>{s.content=$(d)},_e=d=>{for(const o of d)s.content=`${s.content}<span>${o}</span>`},X=T(null);return(d,o)=>{const m=Ve,ge=Ke,ve=Oe,L=Ue,B=je,P=ue,Y=qe,Z=Pe,xe=Ze,ee=Ge,ye=ze,we=Ce;return H(),O(we,{title:e(A),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",title:"自訂訊息"},{title:e(A)}]},{default:n(()=>[t(ee,{class:"bg-sms-grayscale-0 rounded-4 p-10",wrap:!1},{default:n(()=>[t(B,{flex:"auto"},{default:n(()=>[t(ye,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:pe},{default:n(()=>[t(ee,{gutter:[16,16]},{default:n(()=>[t(B,{span:24},{default:n(()=>[t(L,N(e(b).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[v("div",dt,[mt,e(_)?(H(),O(ge,{key:0,type:"link",class:"m-0 p-0",onClick:o[0]||(o[0]=Ie(()=>_.value=!1,["prevent"]))},{icon:n(()=>[t(m,{name:"plus"})]),default:n(()=>[h(" 新增訊息類別 ")]),_:1})):ce("",!0)])]),default:n(()=>[t(ve,{value:e(s).categoryId,"onUpdate:value":o[1]||(o[1]=k=>e(s).categoryId=k),options:e(x),"allow-clear":"",disabled:!e(_),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),se(t(B,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(L,N({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(b).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[pt,t(P,{status:"small3",class:"m-0 p-0 ms-auto",onClick:o[2]||(o[2]=()=>{e(E)("newSmsCategory"),_.value=!0})},{icon:n(()=>[t(m,{name:"close"})]),_:1})]),default:n(()=>[t(Y,{placeholder:"請輸入訊息類別",maxlength:15,value:e(s).newSmsCategory,"onUpdate:value":o[3]||(o[3]=k=>e(s).newSmsCategory=k)},null,8,["value"])]),_:1},16)]),_:1},512),[[oe,!e(_)]]),t(B,{span:24},{default:n(()=>[t(L,N({label:"訊息名稱"},e(b).name,{extra:"15 字以內"}),{default:n(()=>[t(Y,{value:e(s).name,"onUpdate:value":o[4]||(o[4]=k=>e(s).name=k),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(B,{span:24},{default:n(()=>{var k;return[t(L,N({label:"訊息內容"},e(b).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(V)(e(s).content)?"--":(k=e(s).content)==null?void 0:k.replace(e(ae),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>[t(xe,{contenteditable:"true",modelValue:e(s).content,"onUpdate:modelValue":o[7]||(o[7]=G=>e(s).content=G),placeholder:"請輸入訊息名稱"},{default:n(()=>[t(Z,null,{title:n(()=>[h(" 載入現有的自訂訊息 ")]),default:n(()=>[t(m,{name:"import",onClick:o[5]||(o[5]=G=>{var D;return(D=e(Q))==null?void 0:D.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(Z,null,{title:n(()=>[h(" 加入參數 ")]),default:n(()=>[t(m,{onClick:o[6]||(o[6]=G=>{var D;return(D=e(X))==null?void 0:D.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(m,{name:"link",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(m,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue"])]),_:1},16,["extra"])]}),_:1}),t(B,{span:24,class:"text-end"},{default:n(()=>[t(P,{status:"small2",class:"me-2",onClick:o[8]||(o[8]=k=>d.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[h("取消")]),_:1}),t(P,{status:"small1","html-type":"submit"},{default:n(()=>[h("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),t(B,{flex:"428px",class:"relative"},{default:n(()=>{var k;return[v("img",{src:e(et),class:Be("w-428px")},null,8,ft),se(v("div",{class:"absolute top-[150px] left-[30px] bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:(k=e(s).content)==null?void 0:k.replace(e(Xe),"")},null,8,_t),[[oe,!e(V)(e(s).content)]])]}),_:1})]),_:1}),t(ot,{ref_key:"importCustomMessageRef",ref:Q,onUpdateContent:fe,content:e(s).content},null,8,["content"]),t(it,{ref_key:"addFieldRef",ref:X,onAddFieldToContent:_e},null,512)]),_:1},8,["title","customBreadcrumb"])}}});export{St as default};
