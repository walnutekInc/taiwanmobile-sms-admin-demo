import{_ as Ce}from"./index.vuevuetypescriptsetuptruelang-2ebee2f2.js";import{d as j,ag as Z,ah as be,o as ae,j as he,r as N,f as k,w as ee,y as ke,W as B,X as G,_ as O,u as e,a8 as Se,Y as m,Q as Me,F as le,k as t,$ as n,a3 as $e,a4 as re,H as z,G as C,ad as ie,l as Te,ac as Re,c as te,D as Fe,ab as L,B as Ie,m as ne,A as se,a5 as Be}from"./vue-b9a22f97.js";import{_ as ce}from"./index.vuevuetypescriptsetuptruelang-4fca776e.js";import{j as He,h as Ae,k as De,_ as Ve}from"./index-76f22c88.js";import{E as de,G as Le,H as E,J as Ee,B as Ne,s as Oe,q as je,r as Ke,I as Ue,K as Pe,u as qe,F as Ge}from"./antd-b020a38c.js";import{u as ze}from"./sms-category-4878f09d.js";import{F as We,_ as Je}from"./request-3f3ec6f8.js";import{u as ue,r as oe,a as Qe}from"./custom-message-3c439f37.js";import"./context-deaf53ad.js";const Xe={class:"form-textarea-tools py-2"},Ye=j({__name:"index",props:Z({contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:Z({returned:String},["update:modelValue"]),setup(S,{emit:b}){function v(s,c,M){return s.split(c).join(M)}const p=S,l=be(S,"modelValue");ae(()=>{document.addEventListener("selectionchange",T)}),he(()=>{document.removeEventListener("selectionchange",T)});function i(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const f=N({contentId:`content${i()}`,isLocked:!1,currentTagId:null,savedRange:{}}),h=b;function T(){var c;let s=window.getSelection();if(s){let M=s.rangeCount>0?s.getRangeAt(0):null;M&&((c=M.commonAncestorContainer.ownerDocument)!=null&&c.activeElement)&&M.commonAncestorContainer.ownerDocument.activeElement.id===f.contentId&&(f.savedRange=M)}}const d=k();function r(){return p.noHtml?d.value.innerText:d.value.innerHTML}function _(s){p.noHtml?d.value.innerText=e(s):d.value.innerHTML=e(s)}function R(){l.value=r()}function u(s){s.preventDefault();let c=(s.originalEvent||s).clipboardData.getData("text/plain");p.noNl&&(c=v(c,`\r
`," "),c=v(c,`
`," "),c=v(c,"\r"," ")),window.document.execCommand("insertText",!1,c)}function F(s){s.key=="Enter"&&p.noNl&&(s.preventDefault(),h("returned",r()))}return ee(l,async s=>{await ke(),s!=r()&&_(s??"")}),ee(()=>p.noHtml,()=>{_(l??"")}),(s,c)=>(B(),G(le,null,[(B(),O(Se("div"),{class:"tag-textarea",id:e(f).contentId,contenteditable:S.contenteditable,onInput:R,onBlur:R,onPaste:u,onKeypress:F,ref_key:"element",ref:d,"data-placeholder":S.placeholder},null,40,["id","contenteditable","data-placeholder"])),m("div",Xe,[Me(s.$slots,"default")])],64))}});const Ze="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",et={class:"px-24px"},tt={key:0,class:"line-clamp-2"},nt=m("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),st=j({__name:"import-custom-message",emits:["updateContent"],setup(S,{expose:b,emit:v}){const p=v,l=N({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:i,getCustomMessages:f,pagination:h}=ue(),T=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],d=k({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),r=async(o,x,y)=>{console.log("pagination:",o,"sorter:",y),d.value=Object.assign(d.value,{sortField:y.field,sortOrder:y.order}),await _(o.current,o.pageSize)},_=async(o=1,x=10)=>{let y={current:o,pageSize:x,...e(d)};await f(y)},R=(o,x)=>{console.log("selectedRowKeys changed: ",o,x),l.selectedRowKeys=o,l.selectedRows=x},u=k(!1),F=async()=>{l.selectedRowKeys=[],l.selectedRows=[],_(),u.value=!0},s=k(!1),c=()=>{s.value=!0},M=()=>{var o;u.value=!1,s.value=!1,p("updateContent",(o=l.selectedRows[0])==null?void 0:o.content)};return b({show:F}),(o,x)=>{const y=We,K=Je,D=de;return B(),G(le,null,[t(D,{open:e(u),"onUpdate:open":x[0]||(x[0]=I=>z(u)?u.value=I:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:c,width:"960px"},{default:n(()=>[m("div",et,[t(y,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(K,{class:"modal-table",dataSource:e(i),columns:T,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(l).selectedRowKeys,onChange:R,type:"radio"},onChange:r,pagination:{...e(h)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:I,text:U})=>[I.dataIndex==="content"?(B(),G("div",tt,$e(U),1)):re("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open"]),t(D,{open:e(s),"onUpdate:open":x[1]||(x[1]=I=>z(s)?s.value=I:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:M,width:"440px"},{default:n(()=>[nt]),_:1},8,["open"])],64)}}}),ot={class:"px-24px"},at=m("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),lt={class:"flex justify-between gap-x-2"},rt=m("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[C(" 加入參數功能說明："),m("br"),C(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),it=j({__name:"add-field",emits:["addFieldToContent"],setup(S,{expose:b,emit:v}){const p=v,l=k(!1),i=k([]),f=d=>{i.value.includes(d)?i.value=i.value.filter(r=>r!==d):i.value.push(d)},h=async()=>{i.value=[],l.value=!0},T=()=>{l.value=!1,p("addFieldToContent",i.value)};return b({show:h}),(d,r)=>{const _=ce,R=de;return B(),O(R,{open:e(l),"onUpdate:open":r[5]||(r[5]=u=>z(l)?l.value=u:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:T,width:"600px"},{default:n(()=>[m("div",ot,[at,m("div",lt,[t(_,{status:e(i).includes("%field1%")?"small1":"small2",onClick:r[0]||(r[0]=u=>f("%field1%"))},{default:n(()=>[C("%field1%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field2%")?"small1":"small2",onClick:r[1]||(r[1]=u=>f("%field2%"))},{default:n(()=>[C("%field2%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field3%")?"small1":"small2",onClick:r[2]||(r[2]=u=>f("%field3%"))},{default:n(()=>[C("%field3%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field4%")?"small1":"small2",onClick:r[3]||(r[3]=u=>f("%field4%"))},{default:n(()=>[C("%field4%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field5%")?"small1":"small2",onClick:r[4]||(r[4]=u=>f("%field5%"))},{default:n(()=>[C("%field5%")]),_:1},8,["status"])]),rt])]),_:1},8,["open"])}}}),ct=()=>{const S=ie(),b=k(!1),v=()=>b.value=!0,p=()=>b.value=!1,l=He();return S.beforeResolve((i,f,h)=>{e(b)?l.confirm({closable:!0,width:"440px",icon:()=>"",title:"是否放棄目前編輯的內容？",content:Te("div",{class:"text-center !w-full !max-w-full py-20px text-base mx-auto",innerHTML:"您將離開現在的頁面，且編輯的內容不會存檔"}),okText:"確定",cancelText:"取消",centered:!0,onOk:()=>{p(),h()},onCancel:()=>{h(!1)}}):h()}),ae(()=>{v()}),{setShowAlert:v,setHideAlert:p}},dt={class:"bg-sms-grayscale-0 rounded-4 flex justify-center p-10"},ut={class:"flex-1 me-8"},mt={class:"flex justify-between w-full items-center"},pt=m("span",{class:""},"訊息類別",-1),ft=m("span",null,"新增訊息類別",-1),_t={class:"relative"},gt=["src"],vt=["innerHTML"],$t=j({__name:"custom-message-form",setup(S){const{setHideAlert:b}=ct(),v=ie(),p=Ae(),l=Re(),i=De(),{getSmsCategoryOption:f,smsCategoryOption:h,checkSmsCategoryExist:T}=ze(),{customMeesage:d,getCustomMessage:r,updateCustomMessage:_,createCustomMessage:R,replaceFieldToHtml:u}=ue(),F=te(()=>l.name=="CustomMessageCreate");Fe(async()=>{var g,a;F.value||(await r(l.params.id),I({categoryId:void 0,newSmsCategory:"",name:((g=d.value)==null?void 0:g.name)??"",content:u((a=d.value)==null?void 0:a.content)})),p.handleSelectedKeys(["/sms-marketing/custom-message"]),f()});const s=k(!0),c=te(()=>F.value?"新增自訂訊息":"編輯自訂訊息"),o=N(Le({categoryId:void 0,newSmsCategory:"",name:"",content:""})),x=N({content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(g,a){var w;return!E(a)&&((w=o.content)==null?void 0:w.replace(oe,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(g,a){return!E(a)&&await T(a)?Promise.reject(`系統中已有「${a}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:y,validate:K,clearValidate:D,resetFields:I,initialModel:U}=Ee(o,x),me=()=>{console.log(U),K().then(async()=>{var w;((w=(await(e(F)?R:_)(o,l.params.id)).data)==null?void 0:w.status)==="success"&&(i.success({message:e(F)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),b(),v.push("/sms-marketing/custom-message?tabActived=customMessage"))}).catch(g=>{console.log(g)})},W=k(null),pe=g=>{o.content=u(g)},fe=g=>{for(const a of g)o.content=`${o.content}<span>${a}</span>`},J=k(null);return(g,a)=>{const w=Ve,_e=Ne,ge=Oe,V=je,H=Ke,P=ce,Q=Ue,X=Pe,ve=Ye,xe=qe,ye=Ge,we=Ce;return B(),O(we,{title:e(c),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",title:"自訂訊息"},{title:e(c)}]},{default:n(()=>{var Y;return[m("div",dt,[m("div",ut,[t(ye,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:me},{default:n(()=>[t(xe,{gutter:[16,16]},{default:n(()=>[t(H,{span:24},{default:n(()=>[t(V,L(e(y).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[m("div",mt,[pt,e(s)?(B(),O(_e,{key:0,type:"link",class:"m-0 p-0",onClick:a[0]||(a[0]=Ie(()=>s.value=!1,["prevent"]))},{icon:n(()=>[t(w,{name:"plus"})]),default:n(()=>[C(" 新增訊息類別 ")]),_:1})):re("",!0)])]),default:n(()=>[t(ge,{value:e(o).categoryId,"onUpdate:value":a[1]||(a[1]=$=>e(o).categoryId=$),options:e(h),"allow-clear":"",disabled:!e(s),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),ne(t(H,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(V,L({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(y).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[ft,t(P,{status:"small3",class:"m-0 p-0 ms-auto",onClick:a[2]||(a[2]=()=>{e(o).newSmsCategory="",e(D)("newSmsCategory"),s.value=!0})},{icon:n(()=>[t(w,{name:"close"})]),_:1})]),default:n(()=>[t(Q,{placeholder:"請輸入訊息類別",maxlength:15,value:e(o).newSmsCategory,"onUpdate:value":a[3]||(a[3]=$=>e(o).newSmsCategory=$)},null,8,["value"])]),_:1},16)]),_:1},512),[[se,!e(s)]]),t(H,{span:24},{default:n(()=>[t(V,L({label:"訊息名稱"},e(y).name,{extra:"15 字以內"}),{default:n(()=>[t(Q,{value:e(o).name,"onUpdate:value":a[4]||(a[4]=$=>e(o).name=$),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(H,{span:24},{default:n(()=>{var $;return[t(V,L({label:"訊息內容"},e(y).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(E)(e(o).content)?"--":($=e(o).content)==null?void 0:$.replace(e(oe),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>[t(ve,{contenteditable:"true",modelValue:e(o).content,"onUpdate:modelValue":a[7]||(a[7]=q=>e(o).content=q),placeholder:"請輸入訊息名稱"},{default:n(()=>[t(X,null,{title:n(()=>[C(" 載入現有的自訂訊息 ")]),default:n(()=>[t(w,{name:"import",onClick:a[5]||(a[5]=q=>{var A;return(A=e(W))==null?void 0:A.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(X,null,{title:n(()=>[C(" 加入參數 ")]),default:n(()=>[t(w,{onClick:a[6]||(a[6]=q=>{var A;return(A=e(J))==null?void 0:A.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(w,{name:"link",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(w,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue"])]),_:1},16,["extra"])]}),_:1}),t(H,{span:24,class:"text-end"},{default:n(()=>[t(P,{status:"small2",class:"me-2",onClick:a[8]||(a[8]=$=>g.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[C("取消")]),_:1}),t(P,{status:"small1","html-type":"submit"},{default:n(()=>[C("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),m("div",_t,[m("img",{src:e(Ze),class:Be("w-428px")},null,8,gt),ne(m("div",{class:"absolute top-[150px] left-[30px] bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:(Y=e(o).content)==null?void 0:Y.replace(e(Qe),"")},null,8,vt),[[se,!e(E)(e(o).content)]])])]),t(st,{ref_key:"importCustomMessageRef",ref:W,onUpdateContent:pe},null,512),t(it,{ref_key:"addFieldRef",ref:J,onAddFieldToContent:fe},null,512)]}),_:1},8,["title","customBreadcrumb"])}}});export{$t as default};
