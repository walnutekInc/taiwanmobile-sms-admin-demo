import{_ as ve}from"./index.vuevuetypescriptsetuptruelang-6841d67d.js";import{d as O,ag as Z,ah as xe,o as ye,j as we,r as K,f as M,w as G,y as Ce,W as B,X as z,_ as L,u as e,a8 as be,Y as m,Q as he,F as oe,k as t,$ as n,a3 as ke,a4 as ae,H as W,G as w,ad as Se,ac as $e,c as ee,D as Me,ab as N,B as Te,m as te,A as ne,a5 as Fe}from"./vue-b9a22f97.js";import{_ as le}from"./index.vuevuetypescriptsetuptruelang-4fca776e.js";import{h as Re,j as Ie,_ as Be}from"./index-96a3a3fb.js";import{E as re,G as De,H as j,J as He,B as Ve,s as Ae,q as Ee,r as Ne,I as je,K as Ke,u as Le,F as Oe}from"./antd-b020a38c.js";import{u as Ue}from"./sms-category-3913442c.js";import{F as Pe,_ as qe}from"./request-666fec6f.js";import{u as ie,r as se,a as Ge}from"./custom-message-53e4b68a.js";import"./context-4596d1c6.js";const ze={class:"form-textarea-tools py-2"},We=O({__name:"index",props:Z({tag:String,contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:Z({returned:String},["update:modelValue"]),setup(T,{emit:F}){function C(s,u,a){return s.split(u).join(a)}const f=T,r=xe(T,"modelValue");ye(()=>{document.addEventListener("selectionchange",b)}),we(()=>{document.removeEventListener("selectionchange",b)});function c(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const v=K({contentId:`content${c()}`,isLocked:!1,currentTagId:null,savedRange:{}}),R=F;function b(){var u;let s=window.getSelection();if(s){let a=s.rangeCount>0?s.getRangeAt(0):null;a&&((u=a.commonAncestorContainer.ownerDocument)!=null&&u.activeElement)&&a.commonAncestorContainer.ownerDocument.activeElement.id===v.contentId&&(v.savedRange=a)}}const d=M();function l(){return f.noHtml?d.value.innerText:d.value.innerHTML}function _(s){f.noHtml?d.value.innerText=e(s):d.value.innerHTML=e(s)}function h(){r.value=l()}function i(s){s.preventDefault();let u=(s.originalEvent||s).clipboardData.getData("text/plain");f.noNl&&(u=C(u,`\r
`," "),u=C(u,`
`," "),u=C(u,"\r"," ")),window.document.execCommand("insertText",!1,u)}function k(s){s.key=="Enter"&&f.noNl&&(s.preventDefault(),R("returned",l()))}return G(r,async s=>{await Ce(),s!=l()&&_(s??"")}),G(()=>f.noHtml,()=>{_(r??"")}),G(()=>f.tag,()=>{_(r??"")},{flush:"post"}),(s,u)=>(B(),z(oe,null,[(B(),L(be("div"),{class:"tag-textarea",id:e(v).contentId,contenteditable:T.contenteditable,onInput:h,onBlur:h,onPaste:i,onKeypress:k,ref_key:"element",ref:d,"data-placeholder":T.placeholder},null,40,["id","contenteditable","data-placeholder"])),m("div",ze,[he(s.$slots,"default")])],64))}});const Je="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",Qe={class:"px-24px"},Xe={key:0,class:"line-clamp-2"},Ye=m("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),Ze=O({__name:"import-custom-message",emits:["updateContent"],setup(T,{expose:F,emit:C}){const f=C,r=K({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:c,getCustomMessages:v,pagination:R}=ie(),b=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],d=M({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),l=async(g,p,S)=>{console.log("pagination:",g,"sorter:",S),d.value=Object.assign(d.value,{sortField:S.field,sortOrder:S.order}),await _(g.current,g.pageSize)},_=async(g=1,p=10)=>{let S={current:g,pageSize:p,...e(d)};await v(S)},h=(g,p)=>{console.log("selectedRowKeys changed: ",g,p),r.selectedRowKeys=g,r.selectedRows=p},i=M(!1),k=async()=>{r.selectedRowKeys=[],r.selectedRows=[],_(),i.value=!0},s=M(!1),u=()=>{s.value=!0},a=()=>{var g;i.value=!1,s.value=!1,f("updateContent",(g=r.selectedRows[0])==null?void 0:g.content)};return F({show:k}),(g,p)=>{const S=Pe,U=qe,V=re;return B(),z(oe,null,[t(V,{open:e(i),"onUpdate:open":p[0]||(p[0]=I=>W(i)?i.value=I:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:u,width:"960px"},{default:n(()=>[m("div",Qe,[t(S,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(U,{class:"modal-table",dataSource:e(c),columns:b,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(r).selectedRowKeys,onChange:h,type:"radio"},onChange:l,pagination:{...e(R)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:I,text:A})=>[I.dataIndex==="content"?(B(),z("div",Xe,ke(A),1)):ae("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open"]),t(V,{open:e(s),"onUpdate:open":p[1]||(p[1]=I=>W(s)?s.value=I:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:a,width:"440px"},{default:n(()=>[Ye]),_:1},8,["open"])],64)}}}),et={class:"px-24px"},tt=m("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),nt={class:"flex justify-between gap-x-2"},st=m("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[w(" 加入參數功能說明："),m("br"),w(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),ot=O({__name:"add-field",emits:["addFieldToContent"],setup(T,{expose:F,emit:C}){const f=C,r=M(!1),c=M([]),v=d=>{c.value.includes(d)?c.value=c.value.filter(l=>l!==d):c.value.push(d)},R=async()=>{c.value=[],r.value=!0},b=()=>{r.value=!1,f("addFieldToContent",c.value)};return F({show:R}),(d,l)=>{const _=le,h=re;return B(),L(h,{open:e(r),"onUpdate:open":l[5]||(l[5]=i=>W(r)?r.value=i:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:b,width:"600px"},{default:n(()=>[m("div",et,[tt,m("div",nt,[t(_,{status:e(c).includes("%field1%")?"small1":"small2",onClick:l[0]||(l[0]=i=>v("%field1%"))},{default:n(()=>[w("%field1%")]),_:1},8,["status"]),t(_,{status:e(c).includes("%field2%")?"small1":"small2",onClick:l[1]||(l[1]=i=>v("%field2%"))},{default:n(()=>[w("%field2%")]),_:1},8,["status"]),t(_,{status:e(c).includes("%field3%")?"small1":"small2",onClick:l[2]||(l[2]=i=>v("%field3%"))},{default:n(()=>[w("%field3%")]),_:1},8,["status"]),t(_,{status:e(c).includes("%field4%")?"small1":"small2",onClick:l[3]||(l[3]=i=>v("%field4%"))},{default:n(()=>[w("%field4%")]),_:1},8,["status"]),t(_,{status:e(c).includes("%field5%")?"small1":"small2",onClick:l[4]||(l[4]=i=>v("%field5%"))},{default:n(()=>[w("%field5%")]),_:1},8,["status"])]),st])]),_:1},8,["open"])}}}),at={class:"bg-sms-grayscale-0 rounded-4 flex justify-center p-10"},lt={class:"flex-1 me-8"},rt={class:"flex justify-between w-full items-center"},it=m("span",{class:""},"訊息類別",-1),ct=m("span",null,"新增訊息類別",-1),dt={class:"relative"},ut=["src"],mt=["innerHTML"],bt=O({__name:"custom-message-form",setup(T){const F=Se(),C=Re(),f=$e(),r=Ie(),{getSmsCategoryOption:c,smsCategoryOption:v,checkSmsCategoryExist:R}=Ue(),{customMeesage:b,getCustomMessage:d,updateCustomMessage:l,createCustomMessage:_,replaceFieldToHtml:h}=ie(),i=ee(()=>f.name=="CustomMessageCreate");Me(async()=>{var x;if(!i.value){await d(f.params.id);const o=h((x=b.value)==null?void 0:x.content);V({...b.value,content:o})}C.handleSelectedKeys(["/sms-marketing/custom-message"]),c()});const k=M(!0),s=ee(()=>i.value?"新增自訂訊息":"編輯自訂訊息"),a=K(De({categoryId:void 0,newSmsCategory:"",name:"",content:""})),g=K({content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(x,o){var y;return!j(o)&&((y=a.content)==null?void 0:y.replace(se,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(x,o){return!j(o)&&await R(o)?Promise.reject(`系統中已有「${o}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:p,validate:S,clearValidate:U,resetFields:V}=He(a,g),I=()=>{S().then(async()=>{var y;((y=(await(e(i)?_:l)(a,f.params.id)).data)==null?void 0:y.status)==="success"&&(r.success({message:e(i)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),F.push("/sms-marketing/custom-message?tabActived=customMessage"))}).catch(x=>{console.log(x)})},A=M(null),ce=x=>{a.content=h(x)},de=x=>{for(const o of x)a.content=`${a.content}<span>${o}</span>`},J=M(null);return(x,o)=>{const y=Be,ue=Ve,me=Ae,E=Ee,D=Ne,P=le,Q=je,X=Ke,pe=We,fe=Le,_e=Oe,ge=ve;return B(),L(ge,{title:e(s),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",title:"自訂訊息"},{title:e(s)}]},{default:n(()=>{var Y;return[m("div",at,[m("div",lt,[t(_e,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:I},{default:n(()=>[t(fe,{gutter:[16,16]},{default:n(()=>[t(D,{span:24},{default:n(()=>[t(E,N(e(p).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[m("div",rt,[it,e(k)?(B(),L(ue,{key:0,type:"link",class:"m-0 p-0",onClick:o[0]||(o[0]=Te(()=>k.value=!1,["prevent"]))},{icon:n(()=>[t(y,{name:"plus"})]),default:n(()=>[w(" 新增訊息類別 ")]),_:1})):ae("",!0)])]),default:n(()=>[t(me,{value:e(a).categoryId,"onUpdate:value":o[1]||(o[1]=$=>e(a).categoryId=$),options:e(v),"allow-clear":"",disabled:!e(k),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),te(t(D,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(E,N({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(p).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[ct,t(P,{status:"small3",class:"m-0 p-0 ms-auto",onClick:o[2]||(o[2]=()=>{e(a).newSmsCategory="",e(U)("newSmsCategory"),k.value=!0})},{icon:n(()=>[t(y,{name:"close"})]),_:1})]),default:n(()=>[t(Q,{placeholder:"請輸入訊息類別",maxlength:15,value:e(a).newSmsCategory,"onUpdate:value":o[3]||(o[3]=$=>e(a).newSmsCategory=$)},null,8,["value"])]),_:1},16)]),_:1},512),[[ne,!e(k)]]),t(D,{span:24},{default:n(()=>[t(E,N({label:"訊息名稱"},e(p).name,{extra:"15 字以內"}),{default:n(()=>[t(Q,{value:e(a).name,"onUpdate:value":o[4]||(o[4]=$=>e(a).name=$),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(D,{span:24},{default:n(()=>{var $;return[t(E,N({label:"訊息內容"},e(p).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(j)(e(a).content)?"--":($=e(a).content)==null?void 0:$.replace(e(se),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>[t(pe,{tag:"a-textarea",contenteditable:"true",modelValue:e(a).content,"onUpdate:modelValue":o[7]||(o[7]=q=>e(a).content=q),placeholder:"請輸入訊息名稱"},{default:n(()=>[t(X,null,{title:n(()=>[w(" 載入現有的自訂訊息 ")]),default:n(()=>[t(y,{name:"import",onClick:o[5]||(o[5]=q=>{var H;return(H=e(A))==null?void 0:H.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(X,null,{title:n(()=>[w(" 加入參數 ")]),default:n(()=>[t(y,{onClick:o[6]||(o[6]=q=>{var H;return(H=e(J))==null?void 0:H.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(y,{name:"link",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(y,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue"])]),_:1},16,["extra"])]}),_:1}),t(D,{span:24,class:"text-end"},{default:n(()=>[t(P,{status:"small2",class:"me-2",onClick:o[8]||(o[8]=$=>x.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[w("取消")]),_:1}),t(P,{status:"small1","html-type":"submit"},{default:n(()=>[w("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),m("div",dt,[m("img",{src:e(Je),class:Fe("w-428px")},null,8,ut),te(m("div",{class:"absolute top-[150px] left-[30px] bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:(Y=e(a).content)==null?void 0:Y.replace(e(Ge),"")},null,8,mt),[[ne,!e(j)(e(a).content)]])])]),t(Ze,{ref_key:"importCustomMessageRef",ref:A,onUpdateContent:ce},null,512),t(ot,{ref_key:"addFieldRef",ref:J,onAddFieldToContent:de},null,512)]}),_:1},8,["title","customBreadcrumb"])}}});export{bt as default};
