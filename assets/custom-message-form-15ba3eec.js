import{_ as we}from"./index.vuevuetypescriptsetuptruelang-64223a6e.js";import{d as j,ag as Z,ah as Ce,o as be,j as he,r as N,f as k,w as ee,y as ke,W as B,X as G,_ as O,u as e,a8 as Se,Y as m,Q as Me,F as ae,k as t,$ as n,a3 as $e,a4 as le,H as z,G as w,ai as Te,ad as re,l as Re,ac as Fe,c as te,D as Ie,ab as L,B as Be,m as ne,A as se,a5 as He}from"./vue-86c93dc0.js";import{_ as ie}from"./index.vuevuetypescriptsetuptruelang-e67f29a0.js";import{j as Ae,h as De,k as Ve,_ as Le}from"./index-0a05ee6d.js";import{E as ce,G as Ee,H as E,J as Ne,B as Oe,s as je,q as Ke,r as Ue,I as Pe,K as qe,u as Ge,F as ze}from"./antd-cee5eda1.js";import{u as We}from"./sms-category-adeef2ed.js";import{F as Je,_ as Qe}from"./request-5eac8875.js";import{u as de,r as oe,a as Xe}from"./custom-message-22f4fa52.js";import"./context-097dcb76.js";const Ye={class:"form-textarea-tools py-2"},Ze=j({__name:"index",props:Z({contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:Z({returned:String},["update:modelValue"]),setup(S,{emit:C}){function b(s,c,M){return s.split(c).join(M)}const p=S,l=Ce(S,"modelValue");be(()=>{document.addEventListener("selectionchange",T)}),he(()=>{document.removeEventListener("selectionchange",T)});function i(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const f=N({contentId:`content${i()}`,isLocked:!1,currentTagId:null,savedRange:{}}),h=C;function T(){var c;let s=window.getSelection();if(s){let M=s.rangeCount>0?s.getRangeAt(0):null;M&&((c=M.commonAncestorContainer.ownerDocument)!=null&&c.activeElement)&&M.commonAncestorContainer.ownerDocument.activeElement.id===f.contentId&&(f.savedRange=M)}}const d=k();function r(){return p.noHtml?d.value.innerText:d.value.innerHTML}function _(s){p.noHtml?d.value.innerText=e(s):d.value.innerHTML=e(s)}function R(){l.value=r()}function u(s){s.preventDefault();let c=(s.originalEvent||s).clipboardData.getData("text/plain");p.noNl&&(c=b(c,`\r
`," "),c=b(c,`
`," "),c=b(c,"\r"," ")),window.document.execCommand("insertText",!1,c)}function F(s){s.key=="Enter"&&p.noNl&&(s.preventDefault(),h("returned",r()))}return ee(l,async s=>{await ke(),s!=r()&&_(s??"")}),ee(()=>p.noHtml,()=>{_(l??"")}),(s,c)=>(B(),G(ae,null,[(B(),O(Se("div"),{class:"tag-textarea",id:e(f).contentId,contenteditable:S.contenteditable,onInput:R,onBlur:R,onPaste:u,onKeypress:F,ref_key:"element",ref:d,"data-placeholder":S.placeholder},null,40,["id","contenteditable","data-placeholder"])),m("div",Ye,[Me(s.$slots,"default")])],64))}});const et="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",tt={class:"px-24px"},nt={key:0,class:"line-clamp-2"},st=m("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),ot=j({__name:"import-custom-message",emits:["updateContent"],setup(S,{expose:C,emit:b}){const p=b,l=N({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:i,getCustomMessages:f,pagination:h}=de(),T=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],d=k({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),r=async(o,v,x)=>{console.log("pagination:",o,"sorter:",x),d.value=Object.assign(d.value,{sortField:x.field,sortOrder:x.order}),await _(o.current,o.pageSize)},_=async(o=1,v=10)=>{let x={current:o,pageSize:v,...e(d)};await f(x)},R=(o,v)=>{console.log("selectedRowKeys changed: ",o,v),l.selectedRowKeys=o,l.selectedRows=v},u=k(!1),F=async()=>{l.selectedRowKeys=[],l.selectedRows=[],_(),u.value=!0},s=k(!1),c=()=>{s.value=!0},M=()=>{var o;u.value=!1,s.value=!1,p("updateContent",(o=l.selectedRows[0])==null?void 0:o.content)};return C({show:F}),(o,v)=>{const x=Je,K=Qe,D=ce;return B(),G(ae,null,[t(D,{open:e(u),"onUpdate:open":v[0]||(v[0]=I=>z(u)?u.value=I:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:c,width:"960px"},{default:n(()=>[m("div",tt,[t(x,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(K,{class:"modal-table",dataSource:e(i),columns:T,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(l).selectedRowKeys,onChange:R,type:"radio"},onChange:r,pagination:{...e(h)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:I,text:U})=>[I.dataIndex==="content"?(B(),G("div",nt,$e(U),1)):le("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open"]),t(D,{open:e(s),"onUpdate:open":v[1]||(v[1]=I=>z(s)?s.value=I:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:M,width:"440px"},{default:n(()=>[st]),_:1},8,["open"])],64)}}}),at={class:"px-24px"},lt=m("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),rt={class:"flex justify-between gap-x-2"},it=m("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[w(" 加入參數功能說明："),m("br"),w(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),ct=j({__name:"add-field",emits:["addFieldToContent"],setup(S,{expose:C,emit:b}){const p=b,l=k(!1),i=k([]),f=d=>{i.value.includes(d)?i.value=i.value.filter(r=>r!==d):i.value.push(d)},h=async()=>{i.value=[],l.value=!0},T=()=>{l.value=!1,p("addFieldToContent",i.value)};return C({show:h}),(d,r)=>{const _=ie,R=ce;return B(),O(R,{open:e(l),"onUpdate:open":r[5]||(r[5]=u=>z(l)?l.value=u:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:T,width:"600px"},{default:n(()=>[m("div",at,[lt,m("div",rt,[t(_,{status:e(i).includes("%field1%")?"small1":"small2",onClick:r[0]||(r[0]=u=>f("%field1%"))},{default:n(()=>[w("%field1%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field2%")?"small1":"small2",onClick:r[1]||(r[1]=u=>f("%field2%"))},{default:n(()=>[w("%field2%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field3%")?"small1":"small2",onClick:r[2]||(r[2]=u=>f("%field3%"))},{default:n(()=>[w("%field3%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field4%")?"small1":"small2",onClick:r[3]||(r[3]=u=>f("%field4%"))},{default:n(()=>[w("%field4%")]),_:1},8,["status"]),t(_,{status:e(i).includes("%field5%")?"small1":"small2",onClick:r[4]||(r[4]=u=>f("%field5%"))},{default:n(()=>[w("%field5%")]),_:1},8,["status"])]),it])]),_:1},8,["open"])}}}),dt=Te(()=>{const S=re(),C=k(!1),b=()=>C.value=!0,p=()=>C.value=!1,l=Ae();return S.beforeResolve((i,f,h)=>{e(C)?l.confirm({closable:!0,width:"440px",icon:()=>"",title:"是否放棄目前編輯的內容？",content:Re("div",{class:"text-center !w-full !max-w-full py-20px text-base mx-auto",innerHTML:"您將離開現在的頁面，且編輯的內容不會存檔"}),okText:"確定",cancelText:"取消",centered:!0,onOk:()=>{h(),p()},onCancel:()=>{p(),h(!1)}}):h()}),{setShowAlert:b}}),ut={class:"bg-sms-grayscale-0 rounded-4 flex justify-center p-10"},mt={class:"flex-1 me-8"},pt={class:"flex justify-between w-full items-center"},ft=m("span",{class:""},"訊息類別",-1),_t=m("span",null,"新增訊息類別",-1),gt={class:"relative"},vt=["src"],xt=["innerHTML"],Tt=j({__name:"custom-message-form",setup(S){const{setShowAlert:C}=dt(),b=re(),p=De(),l=Fe(),i=Ve(),{getSmsCategoryOption:f,smsCategoryOption:h,checkSmsCategoryExist:T}=We(),{customMeesage:d,getCustomMessage:r,updateCustomMessage:_,createCustomMessage:R,replaceFieldToHtml:u}=de(),F=te(()=>l.name=="CustomMessageCreate");Ie(async()=>{var g,a;F.value||(await r(l.params.id),I({categoryId:void 0,newSmsCategory:"",name:((g=d.value)==null?void 0:g.name)??"",content:u((a=d.value)==null?void 0:a.content)})),p.handleSelectedKeys(["/sms-marketing/custom-message"]),f()});const s=k(!0),c=te(()=>F.value?"新增自訂訊息":"編輯自訂訊息"),o=N(Ee({categoryId:void 0,newSmsCategory:"",name:"",content:""})),v=N({content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(g,a){var y;return!E(a)&&((y=o.content)==null?void 0:y.replace(oe,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(g,a){return!E(a)&&await T(a)?Promise.reject(`系統中已有「${a}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:x,validate:K,clearValidate:D,resetFields:I,initialModel:U}=Ne(o,v),ue=()=>{console.log(U),K().then(async()=>{var y;((y=(await(e(F)?R:_)(o,l.params.id)).data)==null?void 0:y.status)==="success"&&(i.success({message:e(F)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),b.push("/sms-marketing/custom-message?tabActived=customMessage"))}).catch(g=>{console.log(g)})},W=k(null),me=g=>{o.content=u(g)},pe=g=>{for(const a of g)o.content=`${o.content}<span>${a}</span>`},J=k(null);return(g,a)=>{const y=Le,fe=Oe,_e=je,V=Ke,H=Ue,P=ie,Q=Pe,X=qe,ge=Ze,ve=Ge,xe=ze,ye=we;return B(),O(ye,{title:e(c),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",click:()=>{e(C)()},title:"自訂訊息"},{title:e(c)}]},{default:n(()=>{var Y;return[m("div",ut,[m("div",mt,[t(xe,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:ue},{default:n(()=>[t(ve,{gutter:[16,16]},{default:n(()=>[t(H,{span:24},{default:n(()=>[t(V,L(e(x).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[m("div",pt,[ft,e(s)?(B(),O(fe,{key:0,type:"link",class:"m-0 p-0",onClick:a[0]||(a[0]=Be(()=>s.value=!1,["prevent"]))},{icon:n(()=>[t(y,{name:"plus"})]),default:n(()=>[w(" 新增訊息類別 ")]),_:1})):le("",!0)])]),default:n(()=>[t(_e,{value:e(o).categoryId,"onUpdate:value":a[1]||(a[1]=$=>e(o).categoryId=$),options:e(h),"allow-clear":"",disabled:!e(s),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),ne(t(H,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(V,L({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(x).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[_t,t(P,{status:"small3",class:"m-0 p-0 ms-auto",onClick:a[2]||(a[2]=()=>{e(o).newSmsCategory="",e(D)("newSmsCategory"),s.value=!0})},{icon:n(()=>[t(y,{name:"close"})]),_:1})]),default:n(()=>[t(Q,{placeholder:"請輸入訊息類別",maxlength:15,value:e(o).newSmsCategory,"onUpdate:value":a[3]||(a[3]=$=>e(o).newSmsCategory=$)},null,8,["value"])]),_:1},16)]),_:1},512),[[se,!e(s)]]),t(H,{span:24},{default:n(()=>[t(V,L({label:"訊息名稱"},e(x).name,{extra:"15 字以內"}),{default:n(()=>[t(Q,{value:e(o).name,"onUpdate:value":a[4]||(a[4]=$=>e(o).name=$),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(H,{span:24},{default:n(()=>{var $;return[t(V,L({label:"訊息內容"},e(x).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(E)(e(o).content)?"--":($=e(o).content)==null?void 0:$.replace(e(oe),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>[t(ge,{tag:"a-textarea",contenteditable:"true",modelValue:e(o).content,"onUpdate:modelValue":a[7]||(a[7]=q=>e(o).content=q),placeholder:"請輸入訊息名稱"},{default:n(()=>[t(X,null,{title:n(()=>[w(" 載入現有的自訂訊息 ")]),default:n(()=>[t(y,{name:"import",onClick:a[5]||(a[5]=q=>{var A;return(A=e(W))==null?void 0:A.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(X,null,{title:n(()=>[w(" 加入參數 ")]),default:n(()=>[t(y,{onClick:a[6]||(a[6]=q=>{var A;return(A=e(J))==null?void 0:A.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(y,{name:"link",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(y,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue"])]),_:1},16,["extra"])]}),_:1}),t(H,{span:24,class:"text-end"},{default:n(()=>[t(P,{status:"small2",class:"me-2",onClick:a[8]||(a[8]=$=>g.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[w("取消")]),_:1}),t(P,{status:"small1","html-type":"submit"},{default:n(()=>[w("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),m("div",gt,[m("img",{src:e(et),class:He("w-428px")},null,8,vt),ne(m("div",{class:"absolute top-[150px] left-[30px] bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:(Y=e(o).content)==null?void 0:Y.replace(e(Xe),"")},null,8,xt),[[se,!e(E)(e(o).content)]])])]),t(ot,{ref_key:"importCustomMessageRef",ref:W,onUpdateContent:me},null,512),t(ct,{ref_key:"addFieldRef",ref:J,onAddFieldToContent:pe},null,512)]}),_:1},8,["title","customBreadcrumb"])}}});export{Tt as default};
