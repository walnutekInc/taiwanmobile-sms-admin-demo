import{_ as be}from"./index.vuevuetypescriptsetuptruelang-009f0585.js";import{d as O,ag as oe,ah as ke,o as re,j as he,r as K,f as T,w as W,y as Se,W as H,X as J,_ as q,u as e,a8 as Me,Y as _,Q as $e,F as ce,k as t,$ as n,a3 as Te,a4 as ie,H as Q,G as h,ad as ue,l as Re,ac as Fe,c as se,D as Le,ab as E,B as Ie,m as ae,A as le,a5 as Be}from"./vue-b9a22f97.js";import{_ as de}from"./index.vuevuetypescriptsetuptruelang-6de7385f.js";import{j as He,h as Ae,k as De,_ as Ne}from"./index-61800733.js";import{E as D,G as me,H as Ve,J as Ee,K as Ke,B as qe,s as Oe,q as Ue,r as je,I as Pe,N as Ge,u as ze,F as We}from"./antd-100bd80b.js";import{u as Je}from"./sms-category-aa002f09.js";import{F as Qe,_ as Xe}from"./request-235bd97b.js";import{u as pe,r as z,a as Ye}from"./custom-message-8990e3bb.js";import"./context-29fd9b24.js";const Ze={class:"form-textarea-tools py-2"},et=O({__name:"index",props:oe({contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},maxLen:{type:Number},contentLen:{type:Number},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:oe({returned:String},["update:modelValue"]),setup(M,{emit:g}){function S(o,i,w){return o.split(i).join(w)}const c=M,d=ke(M,"modelValue");re(()=>{document.addEventListener("selectionchange",x)}),he(()=>{document.removeEventListener("selectionchange",x)});function l(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const u=K({contentId:`content${l()}`,isLocked:!1,currentTagId:null,savedRange:{}}),F=g;function x(){var i;let o=window.getSelection();if(o){let w=o.rangeCount>0?o.getRangeAt(0):null;w&&((i=w.commonAncestorContainer.ownerDocument)!=null&&i.activeElement)&&w.commonAncestorContainer.ownerDocument.activeElement.id===u.contentId&&(u.savedRange=w)}}const f=T();function r(){return c.noHtml?f.value.innerText:f.value.innerHTML}function v(o){c.noHtml?f.value.innerText=e(o):f.value.innerHTML=e(o)}function R(){d.value=r()}function y(o){o.preventDefault();let i=(o.originalEvent||o).clipboardData.getData("text/plain");if(c.noNl&&(i=S(i,`\r
`," "),i=S(i,`
`," "),i=S(i,"\r"," ")),c.contentLen&&c.maxLen&&c.contentLen+i.length>=c.maxLen)return o.keyCode===8,void 0;console.log("paste"),window.document.execCommand("insertText",!1,i)}function $(o){o.key=="Enter"&&c.noNl&&(o.preventDefault(),F("returned",r()))}W(d,async o=>{await Se(),o!=r()&&v(o??"")}),W(()=>c.noHtml,()=>{v(d??"")});function L(o){if(c.contentLen&&c.maxLen&&c.contentLen>=c.maxLen){if(o.keyCode===8)return;o.preventDefault()}}return(o,i)=>(H(),J(ce,null,[(H(),q(Me("div"),{class:"tag-textarea",id:e(u).contentId,contenteditable:M.contenteditable,onInput:R,onBlur:R,onPaste:y,onKeypress:$,ref_key:"element",ref:f,"data-placeholder":M.placeholder,onKeydown:L},null,40,["id","contenteditable","data-placeholder"])),_("div",Ze,[$e(o.$slots,"default")])],64))}});const tt="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",nt={class:"px-24px"},ot={key:0,class:"line-clamp-2"},st=_("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),at=O({__name:"import-custom-message",props:{content:{type:String,required:!0}},emits:["updateContent"],setup(M,{expose:g,emit:S}){const c=M,d=S,l=K({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:u,getCustomMessages:F,pagination:x}=pe(),f=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],r=T({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),v=async(s,C,b)=>{console.log("pagination:",s,"sorter:",b),r.value=Object.assign(r.value,{sortField:b.field,sortOrder:b.order}),await R(s.current,s.pageSize)},R=async(s=1,C=10)=>{let b={current:s,pageSize:C,...e(r)};await F(b)},y=(s,C)=>{console.log("selectedRowKeys changed: ",s,C),l.selectedRowKeys=s,l.selectedRows=C},$=T(!1),L=async()=>{l.selectedRowKeys=[],l.selectedRows=[],R(),$.value=!0},o=T(!1),i=()=>{D(c.content)?w():o.value=!0},w=()=>{var s;$.value=!1,o.value=!1,d("updateContent",(s=l.selectedRows[0])==null?void 0:s.content)};return g({show:L}),(s,C)=>{const b=Qe,U=Xe,N=me;return H(),J(ce,null,[t(N,{open:e($),"onUpdate:open":C[0]||(C[0]=I=>Q($)?$.value=I:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:i,width:"960px",okButtonProps:{disabled:e(l).selectedRowKeys.length===0}},{default:n(()=>[_("div",nt,[t(b,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(U,{class:"modal-table",dataSource:e(u),columns:f,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(l).selectedRowKeys,onChange:y,type:"radio"},onChange:v,pagination:{...e(x)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:I,text:j})=>[I.dataIndex==="content"?(H(),J("div",ot,Te(j),1)):ie("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open","okButtonProps"]),t(N,{open:e(o),"onUpdate:open":C[1]||(C[1]=I=>Q(o)?o.value=I:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:w,width:"440px"},{default:n(()=>[st]),_:1},8,["open"])],64)}}}),lt={class:"px-24px"},rt=_("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),ct={class:"flex justify-between gap-x-2"},it=_("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[h(" 加入參數功能說明："),_("br"),h(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),ut=O({__name:"add-field",emits:["addFieldToContent"],setup(M,{expose:g,emit:S}){const c=S,d=T(!1),l=T([]),u=f=>{l.value.includes(f)?l.value=l.value.filter(r=>r!==f):l.value.push(f)},F=async()=>{l.value=[],d.value=!0},x=()=>{d.value=!1,c("addFieldToContent",l.value)};return g({show:F}),(f,r)=>{const v=de,R=me;return H(),q(R,{open:e(d),"onUpdate:open":r[5]||(r[5]=y=>Q(d)?d.value=y:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:x,width:"600px"},{default:n(()=>[_("div",lt,[rt,_("div",ct,[t(v,{status:e(l).includes("%field1%")?"small1":"small2",onClick:r[0]||(r[0]=y=>u("%field1%"))},{default:n(()=>[h("%field1%")]),_:1},8,["status"]),t(v,{status:e(l).includes("%field2%")?"small1":"small2",onClick:r[1]||(r[1]=y=>u("%field2%"))},{default:n(()=>[h("%field2%")]),_:1},8,["status"]),t(v,{status:e(l).includes("%field3%")?"small1":"small2",onClick:r[2]||(r[2]=y=>u("%field3%"))},{default:n(()=>[h("%field3%")]),_:1},8,["status"]),t(v,{status:e(l).includes("%field4%")?"small1":"small2",onClick:r[3]||(r[3]=y=>u("%field4%"))},{default:n(()=>[h("%field4%")]),_:1},8,["status"]),t(v,{status:e(l).includes("%field5%")?"small1":"small2",onClick:r[4]||(r[4]=y=>u("%field5%"))},{default:n(()=>[h("%field5%")]),_:1},8,["status"])]),it])]),_:1},8,["open"])}}}),dt=()=>{const M=ue(),g=T(!1),S=()=>g.value=!0,c=()=>g.value=!1,d=He();M.beforeResolve((u,F,x)=>{e(g)?d.confirm({closable:!0,width:"440px",icon:()=>"",title:"是否放棄目前編輯的內容？",content:Re("div",{class:"text-center !w-full !max-w-full py-20px text-base mx-auto",innerHTML:"您將離開現在的頁面，且編輯的內容不會存檔"}),okText:"確定",cancelText:"取消",centered:!0,onOk:()=>{c(),x()},onCancel:()=>{x(!1)}}):x()});const l=u=>{e(g)&&(u.preventDefault(),u.returnValue=!0)};return re(()=>{window.addEventListener("beforeunload",l)}),{setShowAlert:S,setHideAlert:c}},mt={class:"flex justify-between w-full items-center"},pt=_("span",{class:""},"訊息類別",-1),ft=_("span",null,"新增訊息類別",-1),_t=["src"],gt={class:"max-h-450px overflow-auto absolute top-[150px] left-[30px] w-[calc(100%-50px)]"},xt=["innerHTML"],$t=O({__name:"custom-message-form",setup(M){const{setHideAlert:g,setShowAlert:S}=dt(),c=ue(),d=Ae(),l=Fe(),u=De(),{getSmsCategoryOption:F,smsCategoryOption:x,checkSmsCategoryExist:f}=Je(),{customMeesage:r,getCustomMessage:v,updateCustomMessage:R,createCustomMessage:y,replaceFieldToHtml:$}=pe(),L=se(()=>l.name=="CustomMessageCreate");let o={categoryId:void 0,newSmsCategory:"",name:"",content:""};Le(async()=>{var m,a,p;L.value||(await v(l.params.id),o={categoryId:(m=r.value)==null?void 0:m.categoryId,newSmsCategory:"",name:((a=r.value)==null?void 0:a.name)??"",content:$((p=r.value)==null?void 0:p.content)},I(o)),d.handleSelectedKeys(["/sms-marketing/custom-message"]),F()});const i=T(!0),w=se(()=>L.value?"新增自訂訊息":"編輯自訂訊息"),s=K(Ve(o));W(()=>s,m=>{Ee(m,o)?g():S()},{deep:!0});const C=K({name:[{required:!0,message:"請輸入訊息名稱",trigger:"blur"}],content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(m,a){var p;return!D(a)&&((p=s.content)==null?void 0:p.replace(z,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(m,a){return!D(a)&&await f(a)?Promise.reject(`系統中已有「${a}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:b,validate:U,clearValidate:N,resetFields:I,initialModel:j}=Ke(s,C),fe=()=>{console.log(j),U().then(async()=>{var p;((p=(await(e(L)?y:R)(s,l.params.id)).data)==null?void 0:p.status)==="success"&&(u.success({message:e(L)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),g(),c.push("/sms-marketing/custom-message?tabActived=customMessage"))}).catch(m=>{console.log(m)})},X=T(null),_e=m=>{s.content=$(m)},ge=m=>{for(const a of m)s.content=`${s.content}<span>${a}</span>`},Y=T(null);return(m,a)=>{const p=Ne,xe=qe,ve=Oe,V=Ue,B=je,P=de,Z=Pe,ee=Ge,ye=et,te=ze,we=We,Ce=be;return H(),q(Ce,{title:e(w),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",title:"自訂訊息"},{title:e(w)}]},{default:n(()=>[t(te,{class:"bg-sms-grayscale-0 rounded-4 p-10",wrap:!1},{default:n(()=>[t(B,{flex:"auto"},{default:n(()=>[t(we,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:fe},{default:n(()=>[t(te,{gutter:[16,16]},{default:n(()=>[t(B,{span:24},{default:n(()=>[t(V,E(e(b).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[_("div",mt,[pt,e(i)?(H(),q(xe,{key:0,type:"link",class:"m-0 p-0",onClick:a[0]||(a[0]=Ie(()=>i.value=!1,["prevent"]))},{icon:n(()=>[t(p,{name:"plus"})]),default:n(()=>[h(" 新增訊息類別 ")]),_:1})):ie("",!0)])]),default:n(()=>[t(ve,{value:e(s).categoryId,"onUpdate:value":a[1]||(a[1]=k=>e(s).categoryId=k),options:e(x),"allow-clear":"",disabled:!e(i),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),ae(t(B,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(V,E({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(b).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[ft,t(P,{status:"small3",class:"m-0 p-0 ms-auto",onClick:a[2]||(a[2]=()=>{e(N)("newSmsCategory"),i.value=!0})},{icon:n(()=>[t(p,{name:"close"})]),_:1})]),default:n(()=>[t(Z,{placeholder:"請輸入訊息類別",maxlength:15,value:e(s).newSmsCategory,"onUpdate:value":a[3]||(a[3]=k=>e(s).newSmsCategory=k)},null,8,["value"])]),_:1},16)]),_:1},512),[[le,!e(i)]]),t(B,{span:24},{default:n(()=>[t(V,E({label:"訊息名稱"},e(b).name,{extra:"15 字以內",required:""}),{default:n(()=>[t(Z,{value:e(s).name,"onUpdate:value":a[4]||(a[4]=k=>e(s).name=k),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(B,{span:24},{default:n(()=>{var k;return[t(V,E({label:"訊息內容"},e(b).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(D)(e(s).content)?"--":(k=e(s).content)==null?void 0:k.replace(e(z),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>{var ne;return[t(ye,{contenteditable:"true",modelValue:e(s).content,"onUpdate:modelValue":a[7]||(a[7]=G=>e(s).content=G),"content-len":(ne=e(s).content)==null?void 0:ne.replace(e(z),"").length,"max-len":1e3,placeholder:"請輸入訊息名稱"},{default:n(()=>[t(ee,null,{title:n(()=>[h(" 載入現有的自訂訊息 ")]),default:n(()=>[t(p,{name:"import",onClick:a[5]||(a[5]=G=>{var A;return(A=e(X))==null?void 0:A.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(ee,null,{title:n(()=>[h(" 加入參數 ")]),default:n(()=>[t(p,{onClick:a[6]||(a[6]=G=>{var A;return(A=e(Y))==null?void 0:A.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(p,{name:"link",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(p,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue","content-len"])]}),_:1},16,["extra"])]}),_:1}),t(B,{span:24,class:"text-end"},{default:n(()=>[t(P,{status:"small2",class:"me-2",onClick:a[8]||(a[8]=k=>m.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[h("取消")]),_:1}),t(P,{status:"small1","html-type":"submit"},{default:n(()=>[h("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),t(B,{flex:"428px",class:"relative"},{default:n(()=>{var k;return[_("img",{src:e(tt),class:Be("w-428px")},null,8,_t),_("div",gt,[ae(_("div",{class:"bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:(k=e(s).content)==null?void 0:k.replace(e(Ye),"")},null,8,xt),[[le,!e(D)(e(s).content)]])])]}),_:1})]),_:1}),t(at,{ref_key:"importCustomMessageRef",ref:X,onUpdateContent:_e,content:e(s).content},null,8,["content"]),t(ut,{ref_key:"addFieldRef",ref:Y,onAddFieldToContent:ge},null,512)]),_:1},8,["title","customBreadcrumb"])}}});export{$t as default};
