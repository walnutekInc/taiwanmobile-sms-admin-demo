import{_ as Fe}from"./index.vuevuetypescriptsetuptruelang-4add89d4.js";import{d as O,ag as le,ah as Ie,o as ue,j as Be,r as N,f as T,w as J,y as He,W as H,X as Q,_ as K,u as e,a8 as Ae,Y as h,Q as De,F as de,k as t,$ as n,a3 as Ee,a4 as me,H as q,G as M,ad as pe,l as Ne,ab as V,ac as Ue,c as re,D as Ve,B as Ke,m as ce,A as ie,a5 as Oe}from"./vue-b9a22f97.js";import{_ as X}from"./index.vuevuetypescriptsetuptruelang-df03164d.js";import{j as Pe,h as je,k as qe,_ as ze}from"./index-858981d5.js";import{E,G as Y,H as fe,J as _e,I as ge,q as xe,r as ve,u as we,F as ye,K as Ge,B as We,s as Je,N as Qe}from"./antd-f7215ad7.js";import{u as Xe}from"./sms-category-6121055d.js";import{F as Ye,_ as Ze}from"./request-74a2fc5c.js";import{u as ke,r as W,a as et}from"./custom-message-dfb61969.js";import"./context-fa4328b9.js";const tt={class:"form-textarea-tools py-2"},nt=O({__name:"index",props:le({contenteditable:{type:[Boolean,String],default:!0},noHtml:{type:Boolean,default:!1},noNl:{type:Boolean,default:!1},maxLen:{type:Number},contentLen:{type:Number},placeholder:String},{modelValue:{required:!0},modelModifiers:{}}),emits:le({returned:String},["update:modelValue"]),setup(R,{emit:g}){function S(o,i,k){return o.split(i).join(k)}const c=R,d=Ie(R,"modelValue");ue(()=>{document.addEventListener("selectionchange",y)}),Be(()=>{document.removeEventListener("selectionchange",y)});function l(){return`r${new Date().getTime()}d${Math.ceil(Math.random()*1e3)}`}const u=N({contentId:`content${l()}`,isLocked:!1,currentTagId:null,savedRange:{}}),F=g;function y(){var i;let o=window.getSelection();if(o){let k=o.rangeCount>0?o.getRangeAt(0):null;k&&((i=k.commonAncestorContainer.ownerDocument)!=null&&i.activeElement)&&k.commonAncestorContainer.ownerDocument.activeElement.id===u.contentId&&(u.savedRange=k)}}const _=T();function r(){return c.noHtml?_.value.innerText:_.value.innerHTML}function m(o){c.noHtml?_.value.innerText=e(o):_.value.innerHTML=e(o)}function L(){d.value=r()}function x(o){o.preventDefault();let i=(o.originalEvent||o).clipboardData.getData("text/plain");if(c.noNl&&(i=S(i,`\r
`," "),i=S(i,`
`," "),i=S(i,"\r"," ")),c.contentLen&&c.maxLen&&c.contentLen+i.length>=c.maxLen)return o.keyCode===8,void 0;console.log("paste"),window.document.execCommand("insertText",!1,i)}function v(o){o.key=="Enter"&&c.noNl&&(o.preventDefault(),F("returned",r()))}J(d,async o=>{await He(),o!=r()&&m(o??"")}),J(()=>c.noHtml,()=>{m(d??"")});function p(o){if(c.contentLen&&c.maxLen&&c.contentLen>=c.maxLen){if(o.keyCode===8)return;o.preventDefault()}}return(o,i)=>(H(),Q(de,null,[(H(),K(Ae("div"),{class:"tag-textarea",id:e(u).contentId,contenteditable:R.contenteditable,onInput:L,onBlur:L,onPaste:x,onKeypress:v,ref_key:"element",ref:_,"data-placeholder":R.placeholder,onKeydown:p},null,40,["id","contenteditable","data-placeholder"])),h("div",tt,[De(o.$slots,"default")])],64))}});const ot="/taiwanmobile-sms-admin-demo/assets/phone-415905dc.png",st={class:"px-24px"},at={key:0,class:"line-clamp-2"},lt=h("div",{class:"px-24px text-center"}," 您重新選擇的自訂訊息內容，將會把現在的訊息完全覆蓋。 ",-1),rt=O({__name:"import-custom-message",props:{content:{type:String,required:!0}},emits:["updateContent"],setup(R,{expose:g,emit:S}){const c=R,d=S,l=N({selectedRowKeys:[],selectedRows:[],loading:!1}),{customMessages:u,getCustomMessages:F,pagination:y}=ke(),_=[{title:"訊息類別",dataIndex:"categoryName",key:"categoryName",sorter:!0,width:"160px"},{title:"訊息名稱",dataIndex:"name",key:"name",sorter:!0,width:"160px"},{title:"訊息內容",dataIndex:"content",key:"content",sorter:!0}],r=T({categoryIds:[],keyword:"",name:"",content:"",sortField:"createTime",sortOrder:"descend"}),m=async(s,C,b)=>{console.log("pagination:",s,"sorter:",b),r.value=Object.assign(r.value,{sortField:b.field,sortOrder:b.order}),await L(s.current,s.pageSize)},L=async(s=1,C=10)=>{let b={current:s,pageSize:C,...e(r)};await F(b)},x=(s,C)=>{console.log("selectedRowKeys changed: ",s,C),l.selectedRowKeys=s,l.selectedRows=C},v=T(!1),p=async()=>{l.selectedRowKeys=[],l.selectedRows=[],L(),v.value=!0},o=T(!1),i=()=>{E(c.content)?k():o.value=!0},k=()=>{var s;v.value=!1,o.value=!1,d("updateContent",(s=l.selectedRows[0])==null?void 0:s.content)};return g({show:p}),(s,C)=>{const b=Ye,U=Ze,I=Y;return H(),Q(de,null,[t(I,{open:e(v),"onUpdate:open":C[0]||(C[0]=A=>q(v)?v.value=A:null),title:"選擇欲載入自訂訊息內容",centered:"",cancelText:"取消",okText:"確定",onOk:i,width:"960px",okButtonProps:{disabled:e(l).selectedRowKeys.length===0}},{default:n(()=>[h("div",st,[t(b,{showFilterBtn:!1,placeholder:"搜尋訊息類別、名稱、內容",class:"mb-2"}),t(U,{class:"modal-table",dataSource:e(u),columns:_,showSorterTooltip:!1,"row-selection":{selectedRowKeys:e(l).selectedRowKeys,onChange:x,type:"radio"},onChange:m,pagination:{...e(y)},customHeaderRow:()=>({class:"modal-table"})},{bodyCell:n(({column:A,text:z})=>[A.dataIndex==="content"?(H(),Q("div",at,Ee(z),1)):me("",!0)]),_:1},8,["dataSource","row-selection","pagination"])])]),_:1},8,["open","okButtonProps"]),t(I,{open:e(o),"onUpdate:open":C[1]||(C[1]=A=>q(o)?o.value=A:null),title:"是否覆蓋現有的自訂訊息內容？",centered:"",cancelText:"取消",okText:"確定",onOk:k,width:"440px"},{default:n(()=>[lt]),_:1},8,["open"])],64)}}}),ct={class:"px-24px"},it=h("p",{class:"text-center"},"選擇想加入的參數後，再點擊確定即可。",-1),ut={class:"flex justify-between gap-x-2"},dt=h("p",{class:"text-sms-grayscale-60 text-sm mt-10"},[M(" 加入參數功能說明："),h("br"),M(" 此為自訂訊息的插入參數功能，參數訊息發送功能位置為【訊息行銷活動】和【參數訊息】。訊息內容可自由插入參數，至多使用 5 個參數，依照上傳參數檔案而組成訊息內容。")],-1),mt=O({__name:"add-field",emits:["addFieldToContent"],setup(R,{expose:g,emit:S}){const c=S,d=T(!1),l=T([]),u=_=>{l.value.includes(_)?l.value=l.value.filter(r=>r!==_):l.value.push(_)},F=async()=>{l.value=[],d.value=!0},y=()=>{d.value=!1,c("addFieldToContent",l.value)};return g({show:F}),(_,r)=>{const m=X,L=Y;return H(),K(L,{open:e(d),"onUpdate:open":r[5]||(r[5]=x=>q(d)?d.value=x:null),title:"加入參數",centered:"",cancelText:"取消",okText:"確定",onOk:y,width:"600px"},{default:n(()=>[h("div",ct,[it,h("div",ut,[t(m,{status:e(l).includes("%field1%")?"small1":"small2",onClick:r[0]||(r[0]=x=>u("%field1%"))},{default:n(()=>[M("%field1%")]),_:1},8,["status"]),t(m,{status:e(l).includes("%field2%")?"small1":"small2",onClick:r[1]||(r[1]=x=>u("%field2%"))},{default:n(()=>[M("%field2%")]),_:1},8,["status"]),t(m,{status:e(l).includes("%field3%")?"small1":"small2",onClick:r[2]||(r[2]=x=>u("%field3%"))},{default:n(()=>[M("%field3%")]),_:1},8,["status"]),t(m,{status:e(l).includes("%field4%")?"small1":"small2",onClick:r[3]||(r[3]=x=>u("%field4%"))},{default:n(()=>[M("%field4%")]),_:1},8,["status"]),t(m,{status:e(l).includes("%field5%")?"small1":"small2",onClick:r[4]||(r[4]=x=>u("%field5%"))},{default:n(()=>[M("%field5%")]),_:1},8,["status"])]),dt])]),_:1},8,["open"])}}}),pt=()=>{const R=pe(),g=T(!1),S=()=>g.value=!0,c=()=>g.value=!1,d=Pe();R.beforeResolve((u,F,y)=>{e(g)?d.confirm({closable:!0,width:"440px",icon:()=>"",title:"是否放棄目前編輯的內容？",content:Ne("div",{class:"text-center !w-full !max-w-full py-20px text-base mx-auto",innerHTML:"您將離開現在的頁面，且編輯的內容不會存檔"}),okText:"確定",cancelText:"取消",centered:!0,onOk:()=>{c(),y()},onCancel:()=>{y(!1)}}):y()});const l=u=>{e(g)&&(u.preventDefault(),u.returnValue=!0)};return ue(()=>{window.addEventListener("beforeunload",l)}),{setShowAlert:S,setHideAlert:c}},ft=O({__name:"add-link",emits:["addLinkToContent"],setup(R,{expose:g,emit:S}){const c=S,d={link:""},l=v=>{var p="^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$",o=new RegExp(p,"i");return v.length<2083&&o.test(v)},u=N(fe(d)),F=N({link:[{validator:async function(v,p){return E(p)?Promise.reject("請輸入縮網址"):l(p)?Promise.resolve():Promise.reject("請輸入有效網址")},trigger:"blur"}]}),{validateInfos:y,resetFields:_,validate:r}=_e(u,F),m=T(!1),L=async()=>{_(d),m.value=!0},x=()=>{r().then(async()=>{c("addLinkToContent",u.link),m.value=!1})};return g({show:L}),(v,p)=>{const o=ge,i=xe,k=ve,s=X,C=we,b=ye,U=Y;return H(),K(U,{open:e(m),"onUpdate:open":p[1]||(p[1]=I=>q(m)?m.value=I:null),title:"加入縮網址",centered:"",width:"600px",cancelText:"取消",okText:"確定",onOk:x},{default:n(()=>[t(b,{ref:"formRef",class:"px-24px",layout:"vertical",autocomplete:"off",onSubmit:x},{default:n(()=>[t(C,{gutter:[16,0]},{default:n(()=>[t(k,{span:24},{default:n(()=>[t(i,V({label:""},e(y).link),{default:n(()=>[t(o,{value:e(u).link,"onUpdate:value":p[0]||(p[0]=I=>e(u).link=I),placeholder:"請輸入原始長網址，範例: https://www.taiwanmobile.com/"},null,8,["value"])]),_:1},16)]),_:1}),t(s,{class:"hidden","html-type":"submit"})]),_:1})]),_:1},512)]),_:1},8,["open"])}}}),_t={class:"flex justify-between w-full items-center"},gt=h("span",{class:""},"訊息類別",-1),xt=h("span",null,"新增訊息類別",-1),vt=["src"],wt={class:"max-h-450px overflow-auto absolute top-[150px] left-[30px] w-[calc(100%-50px)]"},yt=["innerHTML"],Lt=O({__name:"custom-message-form",setup(R){const{setHideAlert:g,setShowAlert:S}=pt(),c=pe(),d=je(),l=Ue(),u=qe(),{getSmsCategoryOption:F,smsCategoryOption:y,checkSmsCategoryExist:_}=Xe(),{customMeesage:r,getCustomMessage:m,updateCustomMessage:L,createCustomMessage:x,replaceFieldToHtml:v}=ke(),p=re(()=>l.name=="CustomMessageCreate");let o={categoryId:void 0,newSmsCategory:"",name:"",content:""};Ve(async()=>{var f,a,w;p.value||(await m(l.params.id),o={categoryId:(f=r.value)==null?void 0:f.categoryId,newSmsCategory:"",name:((a=r.value)==null?void 0:a.name)??"",content:v((w=r.value)==null?void 0:w.content)},A(o)),d.handleSelectedKeys(["/sms-marketing/custom-message"]),F()});const i=T(!0),k=re(()=>p.value?"新增自訂訊息":"編輯自訂訊息"),s=N(fe(o));J(()=>s,f=>{Ge(f,o)?g():S()},{deep:!0});const C=N({name:[{required:!0,message:"請輸入訊息名稱",trigger:"blur"}],content:[{required:!0,message:"請輸入訊息內容",trigger:"blur"},{validator:async function(f,a){var w;return!E(a)&&((w=s.content)==null?void 0:w.replace(W,"").length)>1e3?Promise.reject("限制輸入 1,000 字以內"):Promise.resolve()},trigger:"blur"}],newSmsCategory:[{validator:async function(f,a){return!E(a)&&await _(a)?Promise.reject(`系統中已有「${a}」 ，請勿重複新增`):Promise.resolve()},trigger:"blur"}]}),{validateInfos:b,validate:U,clearValidate:I,resetFields:A,initialModel:z}=_e(s,C),Ce=()=>{console.log(z),U().then(async()=>{var w;((w=(await(e(p)?x:L)(s,l.params.id)).data)==null?void 0:w.status)==="success"&&(u.success({message:e(p)?"自訂訊息新增成功":"自訂訊息編輯成功",placement:"top"}),g(),c.push("/sms-marketing/custom-message?tabActived=customMessage"))}).catch(f=>{console.log(f)})},Z=T(null),be=f=>{s.content=v(f)},ee=T(null),he=f=>{for(const a of f)s.content=`${s.content}<span>${a}</span>`},te=T(null),Se=f=>{s.content=`${s.content}<a href="${f}">${f}</a>`};return(f,a)=>{const w=ze,$e=We,Me=Je,P=xe,D=ve,G=X,ne=ge,oe=Qe,Te=nt,se=we,Re=ye,Le=Fe;return H(),K(Le,{title:e(k),customBreadcrumb:[{title:"訊息行銷活動"},{path:"/sms-marketing/custom-message?tabActived=customMessage",title:"自訂訊息"},{title:e(k)}]},{default:n(()=>[t(se,{class:"bg-sms-grayscale-0 rounded-4 p-10",wrap:!1},{default:n(()=>[t(D,{flex:"auto"},{default:n(()=>[t(Re,{ref:"formRef",class:"px-32px",layout:"vertical",autocomplete:"off",onSubmit:Ce},{default:n(()=>[t(se,{gutter:[16,16]},{default:n(()=>[t(D,{span:24},{default:n(()=>[t(P,V(e(b).categoryId,{extra:"15 字以內。若無選擇/新增，將自動歸類為「未分類」。",labelCol:{style:{width:"100%"}}}),{label:n(()=>[h("div",_t,[gt,e(i)?(H(),K($e,{key:0,type:"link",class:"m-0 p-0",onClick:a[0]||(a[0]=Ke(()=>i.value=!1,["prevent"]))},{icon:n(()=>[t(w,{name:"plus"})]),default:n(()=>[M(" 新增訊息類別 ")]),_:1})):me("",!0)])]),default:n(()=>[t(Me,{value:e(s).categoryId,"onUpdate:value":a[1]||(a[1]=$=>e(s).categoryId=$),options:e(y),"allow-clear":"",disabled:!e(i),placeholder:"請選擇訊息類別"},null,8,["value","options","disabled"])]),_:1},16)]),_:1}),ce(t(D,{span:24,class:"bg-sms-bg-light-mode-gray rounded-md !p-2 !px-3"},{default:n(()=>[t(P,V({extra:"15 字以內。若同時選擇和新增訊息類別，系統只會紀錄「新增訊息類別」。"},e(b).newSmsCategory,{labelCol:{style:{width:"100%"}}}),{label:n(()=>[xt,t(G,{status:"small3",class:"m-0 p-0 ms-auto",onClick:a[2]||(a[2]=()=>{e(I)("newSmsCategory"),i.value=!0})},{icon:n(()=>[t(w,{name:"close"})]),_:1})]),default:n(()=>[t(ne,{placeholder:"請輸入訊息類別",maxlength:15,value:e(s).newSmsCategory,"onUpdate:value":a[3]||(a[3]=$=>e(s).newSmsCategory=$)},null,8,["value"])]),_:1},16)]),_:1},512),[[ie,!e(i)]]),t(D,{span:24},{default:n(()=>[t(P,V({label:"訊息名稱"},e(b).name,{extra:"15 字以內",required:""}),{default:n(()=>[t(ne,{value:e(s).name,"onUpdate:value":a[4]||(a[4]=$=>e(s).name=$),placeholder:"請輸入訊息名稱",maxlength:15},null,8,["value"])]),_:1},16)]),_:1}),t(D,{span:24},{default:n(()=>{var $;return[t(P,V({label:"訊息內容"},e(b).content,{class:"relative",extra:`MMS 上限 1,000 字，SMS 上限 335 字，目前 ${e(E)(e(s).content)?"--":($=e(s).content)==null?void 0:$.replace(e(W),"").length} 字(不含參數字數)`,required:""}),{default:n(()=>{var ae;return[t(Te,{contenteditable:"true",modelValue:e(s).content,"onUpdate:modelValue":a[8]||(a[8]=j=>e(s).content=j),"content-len":(ae=e(s).content)==null?void 0:ae.replace(e(W),"").length,"max-len":1e3,placeholder:"請輸入訊息名稱"},{default:n(()=>[t(oe,null,{title:n(()=>[M(" 載入現有的自訂訊息 ")]),default:n(()=>[t(w,{name:"import",onClick:a[5]||(a[5]=j=>{var B;return(B=e(Z))==null?void 0:B.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(oe,null,{title:n(()=>[M(" 加入參數 ")]),default:n(()=>[t(w,{onClick:a[6]||(a[6]=j=>{var B;return(B=e(ee))==null?void 0:B.show()}),name:"code",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1}),t(w,{name:"link",onClick:a[7]||(a[7]=j=>{var B;return(B=e(te))==null?void 0:B.show()}),class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"}),t(w,{name:"AI",class:"text-sms-bg-dark-mode cursor-pointer me-4",width:"24px"})]),_:1},8,["modelValue","content-len"])]}),_:1},16,["extra"])]}),_:1}),t(D,{span:24,class:"text-end"},{default:n(()=>[t(G,{status:"small2",class:"me-2",onClick:a[9]||(a[9]=$=>f.$router.push("/sms-marketing/custom-message?tabActived=customMessage"))},{default:n(()=>[M("取消")]),_:1}),t(G,{status:"small1","html-type":"submit"},{default:n(()=>[M("確定")]),_:1})]),_:1})]),_:1})]),_:1},512)]),_:1}),t(D,{flex:"428px",class:"relative"},{default:n(()=>{var $;return[h("img",{src:e(ot),class:Oe("w-428px")},null,8,vt),h("div",wt,[ce(h("div",{class:"bg-sms-grayscale-20 p-2 rounded-2 whitespace-pre-wrap max-w-[215px] inline-block break-words",innerHTML:($=e(s).content)==null?void 0:$.replace(e(et),"")},null,8,yt),[[ie,!e(E)(e(s).content)]])])]}),_:1})]),_:1}),t(rt,{ref_key:"importCustomMessageRef",ref:Z,onUpdateContent:be,content:e(s).content},null,8,["content"]),t(mt,{ref_key:"addFieldRef",ref:ee,onAddFieldToContent:he},null,512),t(ft,{ref_key:"addLinkRef",ref:te,onAddLinkToContent:Se},null,512)]),_:1},8,["title","customBreadcrumb"])}}});export{Lt as default};
